$(document).ready(function(){var a=localStorage.getItem("thisUser");if(!a){window.location.href="http://www.gdrtc.org/dd-verification/index.php"}else{if(a=="error"){$("body").html("");window.localStorage.removeItem("thisUser");window.close()}}var b=getUrlParam();if(b!=null||b!=""){userId=JSON.parse(a).userid;getJson({resid:b})}});function getJson(a){$.ajax({url:"../server/reservation/reservation-load.php",dataType:"json",type:"POST",data:a,cache:false,success:function(g){if(g.error==0){var b=g.records.reservation[0];resStatus=b.status;carStatus=g.records.carStatus;reservation=b.id;var h=b.applicant.emplId;if(resStatus=="0"){if(userId==h){$(".td-revoke-div").css("display","block")}}else{$(".td-approval-submit").css("display","none");if(resStatus=="1"){$(".td-return-div").css("display","block")}else{if(resStatus=="3"){$(".td-return-div").css("display","block");$("#td-return-car")[0].textContent=b.returnDt}else{if(resStatus=="4"){$(".td-revoke-div").css("display","block");$("#td-revoke-res")[0].textContent="已撤销"}}}}switch(b.usage){case"0":b.usage="出差";break;case"1":b.usage="接待";break;case"2":b.usage="外勤";break;case"3":b.usage="车辆维修";break;case"4":b.usage="其他";break}carid=b.car.carid;b.plateNumber=b.car.plateNumber;b.model=b.car.model;b.driver=b.driver.name;b.name=b.applicant.name;$("#applicant-avatar").attr("src",b.applicant.avatar);if(b!=null&&b!=""){$(".td-approval-container").setData(b)}if(carStatus.length){addCarStatus()}var f;var d;$.each(b.approval,function(k,l){f="";if(l.comment!=null){d='style="display:block"'}else{d='style="display:none"'}f+='<div class="cd-timeline-block"><div class="cd-timeline-img cd-picture"><img src="'+l.approver.avatar+'" alt="Picture"></div><div class="cd-timeline-content"><div class="cd-timeline-name"><h2>'+l.approver.name+'</h2><div><span class="cd-date">'+l.operateDt+'</span></div></div><p class="approval-result" id="approval-result-'+k+'">'+l.result+'</p><p class="approval-comment"'+d+">"+l.comment+'</p><span class="approval-sequence">'+l.sequence+'</span><span class="approval-userid">'+l.userid+"</span></div></div>";$(".cd-container").append(f);var j=$("#approval-result-"+k);switch(l.result){case"0":j.text("未审批");break;case"1":j.text("已同意");j.css("color","green");break;case"2":j.text("已拒绝");j.css("color","red");break}})}else{$.tdAlert("很遗憾！加载失败")}var c=getApproval();if(c==-1){console.log("error!no approver or have pass!")}else{var e=$(appDiv[c]).find(".approval-userid")[0].textContent;if(e!=userId){$(".td-approval-submit").css("display","none")}}},error:function(b,c){$.tdAlert("很遗憾！传送错误");console.log(b);console.log(c)}})}$("#td-agree-submit").click(function(a){setApproval("1")});$("#td-disagree-submit").click(function(a){setApproval("2")});$("#td-revoke-res").click(function(a){if(resStatus=="0"){$.tdConfirm("真的要撤销吗?",function(b){if(b){showMask();var c={reservationId:reservation};$.ajax({url:"../server/reservation/reservation-revoke.php",type:"POST",data:c,dataType:"json",cache:false,success:function(d){if(!d.error){$.tdAlert("恭喜！撤销成功！");$("#td-revoke-res")[0].textContent="已撤销";resStatus=4}else{$.tdAlert("撤销失败！"+d.errorMsg)}$("#td-mask").hide()},error:function(){$.tdAlert("很遗憾！撤销失败！");$("#td-mask").hide()},})}})}});function setApproval(b){var a=getApproval();if(a==-1){console.log("error!no approver!")}else{$.tdPrompt("",function(c,g){if(c){var f=$(appDiv[a]).find(".approval-sequence")[0].textContent;var e=$(appDiv[a]).find(".cd-date")[0];var d={sequence:f,resid:getUrlParam(),result:b,userid:userId,comment:g};showMask();$.ajax({url:"../server/approval/approve.php",type:"POST",data:d,cache:false,success:function(i){if(!i.error){var h=new Date();e.textContent=h.toLocaleTimeString();if(b=="1"){$(appDiv[a]).find(".approval-result")[0].textContent="已同意";$(appDiv[a]).find(".approval-result").css("color","green")}else{$(appDiv[a]).find(".approval-result")[0].textContent="已拒绝";$(appDiv[a]).find(".approval-result").css("color","red")}if(g){$(appDiv[a]).find(".approval-comment").css("display","block");$(appDiv[a]).find(".approval-comment")[0].textContent=g}$(".td-approval-submit").css("display","none")}else{$.tdAlert("修改审批状态失败！"+i.errorMsg)}$("#td-mask").hide()},error:function(h,i){$.tdAlert("很遗憾！审批失败！");console.log(h);console.log(i)},})}},"审批意见","请输入审批意见（可以为空）")}}function getApproval(){appDiv=$("section>div");var a=-1;for(var b=0;b<appDiv.length;b++){if($(appDiv[b]).find(".approval-result")[0].textContent=="未审批"){a=b;break}}return a}$("#td-return-car").on("touchend",function(b){if(resStatus!="3"){if(carStatus.length>0){if(userId=="03401806572466"){var a={resid:getUrlParam(),userid:userId};showMask();$.ajax({url:"../server/return/return.php",type:"POST",data:a,cache:false,success:function(c){if(JSON.parse(c).error==0){$("#td-return-car")[0].textContent=JSON.parse(c).records.returnDt;$.tdAlert("确认还车成功！")}else{$.tdAlert("确认还车失败！"+JSON.parse(c).errorMsg)}$("#td-mask").hide()},error:function(c,d){$.tdAlert("很遗憾！还车失败！");console.log(c);console.log(d)},})}else{$.tdAlert("您已经还完车了哦，请等待管理员确认！")}}else{showMask();$("#mask-return-div").show()}}});$("#return-title-close").on("touchend",function(a){$("#td-mask").hide()});$("form").submit(function(f){var d=$("form #damageType")[0].value;var g=$("form #damageDetails")[0].value;var a=$("form #unitollGD")[0].value;var b=/^\d+(\.{0,1}\d+){0,1}$/;if(!b.test(a)){$.tdAlert("请输入格式正确的剩余金额！(金额应为非负数)");return false}if(d!="0"&&!g){$.tdAlert("车辆若有损伤，请填写详情~");return false}var c={carid:carid,reservation:reservation,fuelIndicator:parseInt($("form #fuelIndicator")[0].value),unitollGD:a,damageType:parseInt(d),damageDetails:g};$("#mask-return-div").hide();$.ajax({url:"../server/car-management/car-status-update.php",type:"POST",data:c,cache:false,success:function(e){if(JSON.parse(e).error==0){carStatus.push(JSON.parse(e).records);addCarStatus();$.tdAlert("申请还车成功！")}else{$.tdAlert("申请失败！"+JSON.parse(e).errorMsg)}$("#td-mask").hide()},error:function(e,h){$.tdAlert("很遗憾！申请还车失败！请刷新重试");console.log(e);console.log(h)},});return false});$.fn.setData=function(b){var c=this;var a;$.each(b,function(e,d){a=c.find("[id="+e+"]")[0];if(a){a.textContent=d}})};function addCarStatus(){var c=carStatus[0].fuelIndicator+"%";var b;switch(carStatus[0].damageType){case"0":b="无";break;case"1":b="车身损伤";break;case"2":b="零部件损坏";break;case"3":b="设备损坏";break;case"4":b="其他";break;default:b=""}var a='<tr><td class="table-left">剩余油量：</td><td id="fuelIndicator">'+c+'</td></tr><tr><td class="table-left">粤通卡：</td><td id="unitollGD">'+carStatus[0].unitollGD+'元</td></tr><tr><td class="table-left">车辆状况：</td><td id="damageType">'+b+'</td></tr><tr><td class="table-left">损坏详情：</td><td id="damageDetails">'+carStatus[0].damageDetails+"</td></tr>";$(".td-detial-table").append(a)}function getUrlParam(){var c=decodeURI(document.URL);var b=c.split("=")[1].split("&")[0];return b}function showMask(){$("#td-mask").css("height",$(document).height());$("#td-mask").css("width",$(document).width());$("#td-mask").show();$("#td-mask i.fa").show()};