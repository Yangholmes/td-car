var _car=[];var carid="";$(document).ready(function(){$.ajax({url:"../server/car-management/car-load.php",dataType:"json",success:function(a){if(a.error=="0"){_car=a.records;tdFormData();tdFormController()}else{$.tdAlert("读取失败！")}},error:function(a,b){console.log("错误");console.log(a);console.log(b)}})});var tdFormData=function(a){var b=$("ul.td-form-comb-img-text-list");var c='<li class="td-form-comb-img-text-item"><div class="td-form-comb-img-text-item-img"><img src="" ></div><div class="td-form-comb-img-text-item-text"></div></li><div class="td-form-comb-img-text-item-detial" id=""><div>车牌号：<span class="td-car-info-plate-number"></span></div><div>座位数：<span class="td-car-info-seating"></span></div></div>';_car.map(function(d,e,g){var f=$(c);f.eq(0).attr("id","td-car-item-"+d.carid);f.eq(1).attr("id","td-car-detail-"+d.carid);f.find("img").attr("src",d.imageSrc);f.find(".td-form-comb-img-text-item-text").html(d.model);f.find(".td-car-info-plate-number").html(d.plateNumber);f.find(".td-car-info-seating").html(d.seating);f.appendTo(b)})};var tdFormController=function(){slide("#td-history-container",function(h){f(false)});var c=false,b=false;$("body").on("touchstart",function(h){c=false});$("body").on("touchmove",function(h){c=true});$(".td-form-comb").on("touchend",function(h){if(c){return}a.call($(h.currentTarget).find("ul"),true);b=true});$(".td-form-comb ul li").on("touchend",function(k){if(c){return}k.stopPropagation();var h=k.currentTarget.id;var i=h.split("-");carid=i[3];var j=$(k.currentTarget).parent("ul").prev(".td-form-comb-selected").find(".td-form-comb-item"),l=$(k.currentTarget).html();j.html(l).attr("id",h);a.call($(k.currentTarget).parent("ul"));b=false;$("#td-history-container").show();$(".cd-timeline>div").remove();$("#pullTOLoad").text("上拉加载更多......");f(true)});function a(h){if(h){$(".transparent-mask").addClass("popup").show();this.addClass("popup").fadeIn(200);$("body").addClass("fixed")}else{this.addClass("popup").fadeOut(450);$(".transparent-mask").addClass("popup").hide();$("body").removeClass("fixed")}}var g=0,e=0;function f(h){d();var i={offset:$("section>div").length,car:{carid:carid},rowCount:"5",loadStatus1:h};$.ajax({url:"../server/reservation/history-load.php",type:"POST",data:i,dataType:"json",cache:false,success:function(k){if(!k.error){if(h){var n=k.records["resUnfinished"];var m;$.each(n,function(o,p){m='<div class="cd-timeline-block"><div class="cd-timeline-img cd-picture"><img src="'+p.applicant.avatar+'" alt="Picture"></div><div class="cd-timeline-content"><h2>'+p.applicant.name+"</h2><p>起点："+p.startpoint+" 目的地："+p.endpoint+" 用途："+p.usage+"</p><p>约 "+p["schedule-start"]+"<br>至 "+p["schedule-end"]+"<br>备注："+p.remark+"</p></div></div>";$("div.cd-timeline").append(m)});if(n.length===0){m='<div class="cd-timeline-block">无</div>';$("div.cd-timeline").append(m)}}var j;var l=k.records["carStatus"];$.each(l,function(o,p){if(p.noReservation){j='<div class="cd-timeline-block"><div class="cd-timeline-img cd-picture"><img src="http://www.gdrtc.org/car/img/icon/用车申请-图标.png" alt="Picture"></div><div class="cd-timeline-content"><h2>管理员 <span style="font-size:14px;">设置<span></h2><p>剩余油量：'+p.fuelIndicator+"<br>粤通卡余额："+p.unitollGD+"</p></div></div>"}else{j='<div class="cd-timeline-block"><div class="cd-timeline-img cd-picture"><img src="'+p.applicant.avatar+'" alt="Picture"></div><div class="cd-timeline-content"><h2>'+p.applicant.name+"</h2><p>起点："+p.startpoint+" 目的地："+p.endpoint+" 用途："+p.usage+"</p><p>约 "+p["schedule-start"]+"<br>至 "+p["schedule-end"]+'<br><span class="cd-date">归还时间：'+p.returnDt+"</span><br>备注："+p.remark+"</p><p>剩余油量："+p.fuelIndicator+" 粤通卡余额："+p.unitollGD+"<br>损坏情况："+p.damageType+"<br>车辆损坏详情："+p.damageDetails+"</p></div></div>"}$("section").append(j)});if(l.length<5){$("#pullTOLoad").text("加载完成，没有更多数据")}}else{$.tdAlert("加载失败！"+k.errorMsg)}$("#td-mask").hide()},error:function(){$.tdAlert("很遗憾！加载失败！")},xhr:function(){var j=new window.XMLHttpRequest();j.upload.addEventListener("progress",function(k){console.log(k.lengthComputable);if(k.lengthComputable){100*k.loaded/k.total}},false);return j},})}function d(){$("#td-mask").css("height",$(document).height());$("#td-mask").css("width",$(document).width());$("#td-mask").show();$("#td-mask i.fa").show()}};var slide=function(d,i){var a,b,c=false,e=(/hp-tablet/gi).test(navigator.appVersion),f="ontouchstart" in window&&!e;d=$(d);pageH=d.height();winH=$(window).height();var h=d.parent();var g={translate:function(j){d.css({"-webkit-transform":"translate(0,-"+j+"px)",transform:"translate(0,-"+j+"px)"})},setTranslition:function(j){d.css({"-webkit-transition":"all "+j+"s",transition:"all "+j+"s"})},};d.bind("touchstart",function(j){pageH=d.height();if((h.scrollTop()-(pageH-winH)>=0)){var k=typeof event=="undefined"?j:event;c=true;a=f?k.touches[0].pageY:k.pageY;g.setTranslition(0)}});d.bind("touchmove",function(j){if((h.scrollTop()-(pageH-winH)>=0)&&c){var k=typeof event=="undefined"?j:event;b=f?k.touches[0].pageY:k.pageY;if(a>b){k.preventDefault();g.translate(a-b)}}});d.bind("touchend",function(k){if(c){c=false;var j=k.originalEvent.changedTouches[0];b=j.pageY;if(a-b>0){g.setTranslition(0.5);g.translate(0);if(typeof i=="function"){i.call(g,k)}}else{g.translate(0)}}})};